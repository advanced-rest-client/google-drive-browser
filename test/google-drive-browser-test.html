<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <google-drive-browser api-key="abc"></google-drive-browser>
      </template>
    </test-fixture>

    <test-fixture id="token">
      <template>
        <google-drive-browser api-key="testApiKey" access-token="testToken"></google-drive-browser>
      </template>
    </test-fixture>

    <test-fixture id="scopes">
      <template>
        <google-drive-browser api-key="testApiKey" scope="scope1 scope2   scope3"></google-drive-browser>
      </template>
    </test-fixture>

    <script type="module">
    import '../google-drive-browser.js';
    import {DriveServer} from './drive-server-helper.js';
    import {afterNextRender} from '../../../@polymer/polymer/lib/utils/render-status.js';
    import {spy as SinonSpy} from '../../../sinon/pkg/sinon-esm.js';
    suite('Google Drive Browser', function() {
      let element;
      suiteSetup(function() {
        DriveServer.createServer();
      });
      suiteTeardown(function() {
        DriveServer.restore();
      });

      suite('Basics', function() {
        setup(function(done) {
          element = fixture('basic');
          flush(() => done());
        });

        test('loading is undefined', function() {
          assert.isUndefined(element.loading);
        });

        test('query is undefined', function() {
          assert.isUndefined(element.query);
        });

        test('items is undefined', function() {
          assert.isUndefined(element.items);
        });

        test('queryProperties is undefined', function() {
          assert.isUndefined(element.queryProperties);
        });

        test('queryParams is undefined', function() {
          assert.isUndefined(element.queryParams);
        });

        test('_nextPageToken is undefined', function() {
          assert.isUndefined(element._nextPageToken);
        });

        test('_fileId is undefined', function() {
          assert.isUndefined(element._fileId);
        });

        test('selectedView is computed', function(done) {
          afterNextRender(element, () => {
            assert.equal(element.selectedView, 0);
            done();
          });
        });

        test('hasMore is true by default', function() {
          assert.isTrue(element.hasMore);
        });

        test('Access token sets loading to true', function() {
          element.accessToken = 'tokenTest';
          // debouncer is set
          assert.isTrue(element.loading);
        });
      });

      suite('With access token', function() {
        setup(function(done) {
          element = fixture('token');
          setTimeout(function() {
            done();
          }, 20);
        });

        test('selectedView is computed', function() {
          assert.equal(element.selectedView, 1);
        });

        test('sets the items array', function() {
          assert.typeOf(element.items, 'array');
          assert.lengthOf(element.items, 50);
        });

        test('loading is false', function() {
          assert.isFalse(element.loading);
        });
      });

      suite('_hasScope()', function() {
        setup(function() {
          element = fixture('scopes');
        });

        test('returns false if no argument', function() {
          const result = element._hasScope();
          assert.isFalse(result);
        });

        test('returns true if no scope property', function() {
          element.scope = undefined;
          const result = element._hasScope('test1');
          assert.isTrue(result);
        });

        test('returns true for existing scopes', function() {
          let result = element._hasScope('scope1');
          assert.isTrue(result);
          result = element._hasScope('scope2');
          assert.isTrue(result);
        });

        test('Ignores empty matches', function() {
          let result = element._hasScope('scope3');
          assert.isTrue(result);
        });

        test('returns false for unknown scope', function() {
          const result = element._hasScope('testscope');
          assert.isFalse(result);
        });
      });

      suite('_initView()', function() {
        setup(function() {
          element = fixture('basic');
        });

        test('Sets view to authorization for missing access token', function() {
          element._initView();
          assert.equal(element.selectedView, 0);
        });

        test('Sets view to list when token is set', function() {
          element.accessToken = 'test';
          element._initView();
          assert.equal(element.selectedView, 1);
        });

        test('Refreshes items list when items is not set', function() {
          element.accessToken = 'test';
          const spy = SinonSpy(element, '_queryFiles');
          element._initView();
          assert.isTrue(spy.called);
        });

        test('Do not refreshes items list when items is set', function() {
          element.accessToken = 'test';
          element.items = [];
          const spy = SinonSpy(element, '_queryFiles');
          element._initView();
          assert.isFalse(spy.called);
        });
      });

      suite('_accessTokenChanged()', function() {
        setup(function() {
          element = fixture('basic');
        });

        test('Calls _accessTokenChanged()', function() {
          const spy = SinonSpy(element, '_setAuthHeader');
          element._accessTokenChanged(true);
          assert.isTrue(spy.called);
        });

        test('Sets view to authorization if not argument', function() {
          element._accessTokenChanged();
          assert.equal(element.selectedView, 0);
        });

        test('Sets view to list if argument', function() {
          element._accessTokenChanged('test');
          assert.equal(element.selectedView, 1);
        });

        test('Calls _queryFiles() when token and no items', function() {
          const spy = SinonSpy(element, '_queryFiles');
          element.items = undefined;
          element._accessTokenChanged('test');
          assert.isTrue(spy.called);
        });

        test('Won\'t call _queryFiles() when token and items', function() {
          const spy = SinonSpy(element, '_queryFiles');
          element.items = [];
          element._accessTokenChanged('test');
          assert.isFalse(spy.called);
        });
      });

      suite('_queryFiles()', function() {
        setup(function() {
          element = fixture('basic');
          element._setHasMore(false);
          element.accessToken = 'test';
          element._setHasMore(true);
          assert.isUndefined(element.loading);
        });

        test('Sets loading to true', function() {
          element._queryFiles();
          assert.isTrue(element.loading);
        });

        test('queryParams is set', function() {
          element._queryFiles();
          assert.typeOf(element.queryParams, 'object');
        });

        test('Is loading results', function() {
          element._queryFiles();
          assert.isTrue(element.$.query.loading);
        });
      });

      suite('_buildQuery()', function() {
        setup(function() {
          element = fixture('basic');
        });

        test('Returns trashed property only', function() {
          const result = element._buildQuery();
          assert.equal(result, 'trashed = false');
        });

        test('Adds mimeType', function() {
          element.mimeType = 'test';
          const result = element._buildQuery();
          assert.equal(result, 'trashed = false and mimeType="test"');
        });

        test('Adds user query', function() {
          element.query = 'test';
          const result = element._buildQuery();
          assert.equal(result, 'trashed = false and name contains \'test\'');
        });

        test('Adds queryProperties', function() {
          element.queryProperties = {
            'a': '1',
            'b': '2'
          };
          const result = element._buildQuery();
          let compare = 'trashed = false and ';
          compare += 'properties has {key=\'a\' and value=\'1\'} and ';
          compare += 'properties has {key=\'b\' and value=\'2\'}';
          assert.equal(result, compare);
        });

        test('Adds queryProperties negation', function() {
          element.queryProperties = {
            'a': '1',
            'b': '2'
          };
          element.queryPropertiesNegation = true;
          const result = element._buildQuery();
          let compare = 'trashed = false and not ';
          compare += 'properties has {key=\'a\' and value=\'1\'} and not ';
          compare += 'properties has {key=\'b\' and value=\'2\'}';
          assert.equal(result, compare);
        });

        test('All together', function() {
          element.queryProperties = {
            'a': '1',
            'b': '2'
          };
          element.queryPropertiesNegation = true;
          element.mimeType = 'testMime';
          element.query = 'testQuery';
          const result = element._buildQuery();
          let compare = 'trashed = false';
          compare += ' and mimeType="testMime"';
          compare += ' and not properties has {key=\'a\' and value=\'1\'}';
          compare += ' and not properties has {key=\'b\' and value=\'2\'}';
          compare += ' and name contains \'testQuery\'';
          assert.equal(result, compare);
        });
      });

      suite('_setQueryParameters()', function() {
        setup(function() {
          element = fixture('basic');
        });

        test('Sets queryParams', function() {
          element._setQueryParameters();
          assert.typeOf(element.queryParams, 'object');
        });

        test('Sets q property', function() {
          element._setQueryParameters();
          assert.typeOf(element.queryParams.q, 'string');
        });

        test('Sets pageSize property', function() {
          element._setQueryParameters();
          assert.typeOf(element.queryParams.pageSize, 'number');
          assert.equal(element.queryParams.pageSize, element.querySize);
        });

        test('Sets fields property', function() {
          element._setQueryParameters();
          assert.typeOf(element.queryParams.fields, 'string');
        });

        test('Sets orderBy property', function() {
          element._setQueryParameters();
          assert.typeOf(element.queryParams.orderBy, 'string');
        });

        test('Sets orderBy property', function() {
          element._setQueryParameters();
          assert.typeOf(element.queryParams.key, 'string');
          assert.equal(element.queryParams.key, element.apiKey);
        });

        test('pageToken is not set', function() {
          element._setQueryParameters();
          assert.isUndefined(element.queryParams.pageToken);
        });

        test('pageToken is set when _nextPageToken property is set', function() {
          element._nextPageToken = 'testToken';
          element._setQueryParameters();
          assert.equal(element.queryParams.pageToken, 'testToken');
        });
      });

      suite('showList()', () => {
        setup(function() {
          element = fixture('basic');
        });

        test('Sets selectedView', () => {
          element.showList();
          assert.equal(element.selectedView, 1);
        });
      });

      suite('refresh()', () => {
        setup(function() {
          element = fixture('basic');
        });

        test('Calls _resetQuery()', () => {
          const spy = SinonSpy(element, '_resetQuery');
          element.refresh();
          assert.isTrue(spy.called);
        });
      });

      suite('_onSearch()', () => {
        let element;
        let ev;
        setup(function() {
          element = fixture('basic');
          ev = {
            detail: {
              q: 'test-q'
            }
          };
        });

        test('Calls _resetQuery()', () => {
          const spy = SinonSpy(element, '_resetQuery');
          element._onSearch(ev);
          assert.isTrue(spy.called);
        });

        test('Sets query', () => {
          element._onSearch(ev);
          assert.equal(element.query, 'test-q');
        });
      });

      suite('_resetQuery()', () => {
        let element;
        setup(function() {
          element = fixture('basic');
          element._nextPageToken = 'test-token';
          element._setHasMore(false);
          element.items = [];
        });

        test('Calls _queryFiles()', () => {
          const spy = SinonSpy(element, '_queryFiles');
          element._resetQuery();
          assert.isTrue(spy.called);
        });

        test('Resets _nextPageToken', () => {
          element._resetQuery();
          assert.isUndefined(element._nextPageToken);
        });

        test('Resets hasMore', () => {
          element._resetQuery();
          assert.isTrue(element.hasMore);
        });

        test('Resets items', () => {
          element._resetQuery();
          assert.isUndefined(element.items);
        });
      });

      suite('_signedinHandler()', () => {
        let element;
        setup(function() {
          element = fixture('scopes');
        });

        test('Resets authorizing state', () => {
          const node = element.shadowRoot.querySelector('google-drive-authorize');
          node.authorizing = true;
          element._signedinHandler({
            detail: {}
          });
          assert.isFalse(node.authorizing);
        });

        test('Sets accessToken', () => {
          element._signedinHandler({
            detail: {
              token: 'test-token',
              scope: 'scope1'
            }
          });
          assert.equal(element.accessToken, 'test-token');
        });

        test('Ignores token when scope is invalid', () => {
          element._signedinHandler({
            detail: {
              token: 'test-token',
              scope: 'other-scope'
            }
          });
          assert.isUndefined(element.accessToken);
        });

        test('Handles google-signin-success event', () => {
          document.body.dispatchEvent(new CustomEvent('google-signin-success', {
            bubbles: true,
            detail: {
              token: 'test-token',
              scope: 'scope1'
            }
          }));
          assert.equal(element.accessToken, 'test-token');
        });
      });

      suite('_signoutHandler()', () => {
        let element;
        setup(function() {
          element = fixture('scopes');
        });

        test('Resets authorizing state', () => {
          const node = element.shadowRoot.querySelector('google-drive-authorize');
          node.authorizing = true;
          element._signoutHandler();
          assert.isFalse(node.authorizing);
        });

        test('Clears accessToken', () => {
          element.accessToken = 'test-token';
          element._signoutHandler();
          assert.isUndefined(element.accessToken);
        });

        test('Handles google-signout event', () => {
          element.accessToken = 'test-token';
          document.body.dispatchEvent(new CustomEvent('google-signout', {
            bubbles: true,
            detail: {}
          }));
          assert.isUndefined(element.accessToken);
        });
      });

      suite('_handleDriveApiError()', () => {
        let element;
        let errorResponse;
        setup(function() {
          element = fixture('basic');
          errorResponse = {
            error: {
              errors: [{
                message: 'test-message',
                reason: ''
              }]
            }
          };
        });

        function getEvent(status) {
          return {
            detail: {
              request: {
                status,
                xhr: {
                  response: JSON.stringify(errorResponse)
                }
              }
            }
          };
        }

        test('Sets offline message', () => {
          const e = getEvent(0);
          element._handleDriveApiError(e);
          assert.equal(element.errorMessage, 'You are offline.');
        });

        test('Sets error view', () => {
          const e = getEvent(0);
          element._handleDriveApiError(e);
          assert.equal(element.selectedView, 2);
        });

        test('Sets 400 message', () => {
          const e = getEvent(400);
          element._handleDriveApiError(e);
          assert.equal(element.errorMessage, 'The app caused the error in request: test-message');
        });

        test('Sets 401 message', () => {
          const e = getEvent(401);
          element._handleDriveApiError(e);
          assert.equal(element.selectedView, 0);
        });

        test('Sets 404 message', () => {
          const e = getEvent(404);
          element._handleDriveApiError(e);
          assert.equal(element.errorMessage, 'File not found (404).');
        });

        test('Sets 500 message', () => {
          const e = getEvent(500);
          element._handleDriveApiError(e);
          assert.equal(element.errorMessage, 'Drive error: an unexpected error occurred while processing the request.');
        });

        [
          ['dailyLimitExceeded', 'API calls limit for the app has been reqached. Try again tomorrow.'],
          ['userRateLimitExceeded', 'You reached your requests limit for the app. Try again tomorrow.'],
          ['rateLimitExceeded', 'You reached your requests limit for Drive. Try again tomorrow.'],
          ['insufficientFilePermissions', 'You do not have sufficient permissions to the file.'],
          ['domainPolicy', 'The policy for your domain does not allow access to Google Drive ' +
            'by your app.'],
          ['default', 'test-message']
        ].forEach((item) => {
          test(`403 - ${item[0]}`, () => {
            errorResponse.error.errors[0].reason = item[0];
            const e = getEvent(403);
            element._handleDriveApiError(e);
            assert.equal(element.errorMessage, item[1]);
          });
        });

        test('Handles 403 - appNotAuthorizedToFile', () => {
          errorResponse.error.errors[0].reason = 'appNotAuthorizedToFile';
          element._fileId = 'testid';
          element.items = [{id: 'testid'}];
          const spy = SinonSpy(element, '_explainAppNotAuthorized');
          const e = getEvent(403);
          element._handleDriveApiError(e);
          assert.isTrue(spy.called);
          assert.deepEqual(spy.args[0][0], element.items[0]);
        });
      });

      suite('_explainAppNotAuthorized()', () => {
        let element;
        setup(function() {
          element = fixture('scopes');
        });

        test('Sets passed item on the element', () => {
          const item = {id: 'test'};
          element._explainAppNotAuthorized(item);
          const node = element.shadowRoot.querySelector('google-drive-app-not-authorized');
          assert.deepEqual(node.item, item);
        });

        test('Selected error view', () => {
          const item = {id: 'test'};
          element._explainAppNotAuthorized(item);
          assert.equal(element.selectedView, 3);
        });
      });
    });
    </script>

  </body>
</html>
